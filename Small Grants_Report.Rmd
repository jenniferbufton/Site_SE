---
title: Small Grants in Focus
output: 
  html_document:
    toc: true
    toc_float:
      toc_collapsed: true
    toc_depth: 3
    number_sections: true
    theme: flatly
    highlight: tango
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(class)
library(gmodels)
library(rlang)
library(caret)
library(extrafont)
library(leaflet)
library(ggplot2)
library(dplyr)
library(extrafont)
library(leaflet)
library(scales)
library(knitr)
library(tidyverse)
library(forcats)
library(wordcloud2)



#### read in GMS data
setwd("C:/Users/jenniferb/OneDrive - Sport England/GitHub/Small Grants")
sg_df <- read.csv('SG_all.csv', header = TRUE, na.strings = c("","N/A"))

topic_tbl <- read.csv('12Month_top.csv') %>%
  rename("Topic" = Topic.id, "Terms" = Concatenate.Term.)

text_df <- read.csv('12Month_Prog.csv', header = TRUE)

sentiment_df <- read.csv('Sentiment.csv', header = TRUE)%>%
  select("Document", "Sentiment.Prediction", "all.Words") %>%
  rename("Sentiment" = Sentiment.Prediction, `Number of Words` = "all.Words")

# colours for charts
se_colour<- c("#E79AB5", "#B8345C", "#8CCDD6", "#43A8B6", "#00818F", "#C1DC9A", "#7ABB40", "#5D4086")


# transformation for headline figs
sp_vec <- sg_df %>% count(Sport, sort = TRUE)
sp_per <- sp_vec[1,2] / sum(sp_vec$n) * 100
sp_per <- unlist(sp_per)
sp_org <- sg_df %>% count(ORGANISATION_NAME, sort = TRUE) 
sp_org$Times_funded <- ifelse(sp_org$n > 1, "More than once", "Once")
sp_la <- sg_df%>% count(LOCAL_AUTHORITY, sort = TRUE)
sp_fo <- sg_df%>% count(Focus, sort = TRUE)
sp_la_imd <- sg_df[order(sg_df$IMD_RANK),]
sent_tab <- table(sentiment_df$Sentiment)



```

# Introduction

Sport England is a funding body. Sending money out the door to support the sector achieve our outcomes is the lifeblood of what we do as an organisation. 
We recieve numerous applications from a diverse cast of characters, some of which fit the mould of "traditional" operators within this sector, others which may come to us from a slightly different backgrount. All of these applicants go through rigorous assessments carried out by our colleagues in the Investment Management Team. 

<br>

# Headline figures  {.tabset .tabset-fade .tabset-pills} 
These figures are for projects (funded by the Small Grants fund) that have started during our current strategy period (from January 2016 - November 2019):

* Number of awards made: `r nrow(sg_df)`
* Total amount awarded: `r paste0("£", formatC(sum(sg_df$AWARD), format="f", digits=2, big.mark=","))`
* Average amount awarded: `r paste0("£", formatC(mean(sg_df$AWARD), format="f", digits=2, big.mark=","))`
* Average total project cost: `r paste0("£", formatC(mean(sg_df$Total_Project_Cost), format="f", digits=2, big.mark=","))`
* Number of different sports funded: `r length(unique(sg_df$Sport))`
* Most funded sport: `r sp_vec[1,]` applications (`r paste0(formatC(sp_per, format="f", digits=2),"%")`)
* Most funded organisation: `r sp_org[1,1:2]`
* Predominant focus was: `r sp_fo[1,1]` (`r sp_fo[1,2]`)

<br>

## Summary

```{r summary, echo=FALSE, message=FALSE, warning=FALSE, fig.align="center"}
table_df <- sg_df %>%
  rename("URN" = GMS_URN, `Award Amount` =  AWARD, `Total Project Cost` = Total_Project_Cost,  `Partnership Funding` = Partnership_Funding, `Other Funding` = OTHER_FUNDING, `Government Outcome` = Govt_Outcome, "Region" = GOVERNMENT_OFFICE_REGION, `Organisation Type`= Org_Class, `IMD Decile` = "IMD_DECILE") %>%
  select(c(`Award Amount`, `Total Project Cost`, "Sport", "Region", `Organisation Type`, "Focus"))
summary(table_df)
```

## Award amounts

```{r award, echo=FALSE, fig.align="center", message=FALSE, warning=FALSE}
ggplot(sg_df)+
  geom_point(aes(AWARD, Total_Project_Cost), color = "#5D4086")+
  theme(text = element_text(family = "Norwester", size = 12, color = "#525252"),
        plot.title=element_text(size=14,family = "Norwester", face="bold", hjust = 0.5, color = "#525252"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        plot.caption=element_text(size=9, hjust=0, margin=margin(15,0,0,0)),
        legend.position = "left")  +
  scale_color_manual(values = se_colour, name = "Focus")+
  labs( x= "Amount Awarded", y = "Total Project Cost", title = "Funding Amount by Total Project Cost")+
  scale_y_continuous(labels = scales::dollar_format(prefix = "£")) +
  scale_x_continuous(labels = scales::dollar_format(prefix = "£")) 
```

<br>

This graph shows the distribution of a the awards. It visualises five summary statistics (the median, two hinges and two whiskers), and all "outlying" points individually

```{r award_box, echo=FALSE, fig.align="center", message=FALSE, warning=FALSE}
ggplot(sg_df)+
  geom_boxplot(aes(x = "", y = AWARD) , color = "#5D4086", outlier.colour =  "#5D4086", )+
  theme(text = element_text(family = "Norwester", size = 12, color = "#525252"),
        plot.title=element_text(size=14,family = "Norwester", face="bold", hjust = 0.5, color = "#525252"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        plot.caption=element_text(size=9, hjust=0, margin=margin(15,0,0,0)),
        legend.position = "left")  +
  scale_color_manual(values = se_colour, name = "Focus")+
  labs( x= "", y = "Amount Awarded", title = "Funding Amount")+
  scale_y_continuous(labels = scales::dollar_format(prefix = "£"))
```


## Times funded

This graph shows the number of organisations who had been funded by the Small Grants by the number of projects they have been funded for. As per the below, the maximum number of separate funded projects for a single organisation was `r max(sp_org$n)`

```{r fund, echo=FALSE, message=FALSE, warning=FALSE, fig.align="center"}

sp_org$n <- as.factor(sp_org$n)
ggplot(sp_org)+
  geom_bar(aes(x="", y = n, fill = n), stat = "identity" ) +
  coord_polar("y", start = 0)+
  theme(text = element_text(family = "Norwester", size = 12, color = "#525252"),
        plot.title=element_text(size=14,family = "Norwester", face="bold", hjust = 0.5, color = "#525252"),
        axis.text.x = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        plot.caption=element_text(size=9, hjust=0, margin=margin(15,0,0,0)),
        legend.position = "right") +
  labs( x= "", y = "", title = "Number of times an Organisation was Funded", caption = "Funded by Small Grants during current strategy period")+
  scale_fill_manual(values = se_colour, name = "Number of times")

```

## Focus
```{r fo_pie, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
ggplot(sg_df)+
  geom_bar(aes(x="", y = AWARD, fill = Focus), stat = "identity" ) +
  coord_polar("y", start = 0)+
  theme(text = element_text(family = "Norwester", size = 12, color = "#525252"),
        plot.title=element_text(size=14,family = "Norwester", face="bold", hjust = 0.5, color = "#525252"),
        axis.text.x = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        plot.caption=element_text(size=9, hjust=0, margin=margin(15,0,0,0)),
        legend.position = "right") +
  labs( x= "", y = "", title = "Amount Awarded per Focus")+
    scale_fill_manual(values = se_colour)
```

## Sport
```{r sport, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
sg_df %>%
  count(Sport) %>%
  mutate(Sport = fct_reorder(Sport, n, .desc = TRUE)) %>%
  top_n(30) %>%
  ggplot(aes(x= Sport, y = n))+
  geom_bar(stat = "identity", fill = "#5D4086") +
  coord_flip()+
  theme(text = element_text(family = "Norwester", size = 12, color = "#525252"),
        plot.title=element_text(size=14,family = "Norwester", face="bold", hjust = 0.5, color = "#525252"),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
        axis.text.y = element_text(hjust = 1, size = 8),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        plot.caption=element_text(size=9, hjust=0, margin=margin(15,0,0,0)),
        legend.position = "right") +
  labs( x= "Organisation type", y = "Number of Awards", title = "Type of Sport by Number of Awards")
```


## Organisation Type

```{r org, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}

sg_df %>%
  count(Org_Class) %>%
  mutate(Org_Class = fct_reorder(Org_Class, n, .desc = TRUE)) %>%
  top_n(20) %>%
  ggplot(aes(x= Org_Class, y = n))+
  geom_bar(stat = "identity", fill = "#5D4086") +
  coord_flip()+
  theme(text = element_text(family = "Norwester", size = 12, color = "#525252"),
        plot.title=element_text(size=14,family = "Norwester", face="bold", hjust = 0.5, color = "#525252"),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
        axis.text.y = element_text(hjust = 1, size = 8),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        plot.caption=element_text(size=9, hjust=0, margin=margin(15,0,0,0)),
        legend.position = "right") +
  labs( x= "Organisation type", y = "Number of Awards", title = "Number of Awards by Organisation Type")
```

<br>

```{r org_amount, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}

  ggplot(data = sg_df, aes(x= Org_Class, y = AWARD))+
  geom_bar(stat = "identity", fill = "#5D4086") +
  coord_flip()+
  theme(text = element_text(family = "Norwester", size = 12, color = "#525252"),
        plot.title=element_text(size=14,family = "Norwester", face="bold", hjust = 0.5, color = "#525252"),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
        axis.text.y = element_text(hjust = 1, size = 8),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        plot.caption=element_text(size=9, hjust=0, margin=margin(15,0,0,0)),
        legend.position = "right") +
  labs( x= "Organisation type", y = "Award amount", title = "Awards Amount by Organisation Type")+
  scale_y_continuous(labels = scales::dollar_format(prefix = "£"))
  
```

<br>

# Funding across the country {.tabset .tabset-fade .tabset-pills} 

Distribution of funding throughout England 

<style>
.leaflet {
    margin: auto;
}
</style>

## Individual projects

```{r map, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
sg_map <- sg_df %>%
mutate(group = cut(AWARD, breaks = c(0, 500, 1000, 2000, 50000, 7500, 10000, Inf), 
                   labels = c("0 - £500", "£501 - £1,000", "£1,001 - £2,000", "£2,001 - £5,000", "£5,001 - £7,500", "£7,501 - £10,000", "Over £10,000"))) 

pal <- colorFactor(palette = c('#fff7f3','#fde0dd','#fcc5c0','#fa9fb5','#f768a1','#dd3497','#ae017e','#7a0177'), domain = sg_map$group)


leaflet() %>% addTiles() %>%
  addCircleMarkers(data= sg_map, ~longitude, ~latitude, 
                   popup = paste("Amount:", "£", formatC(as.numeric(sg_map$AWARD), big.mark = ",", digits = 10),  "<br>",
                                 "Name:", sg_map$ORGANISATION_NAME), 
                   color = ~pal(group),
                   fillOpacity = ~pal(group),
                   radius = ~sqrt(Total_Project_Cost)* 0.01) %>%
  addLegend("bottomright", pal = pal, values = sg_map$group, title = "Small Grants Awards: Sport England 2019",
            opacity = 1)
```

## Awards by Local Authority

The top LA for number of awards is: `r sp_la[1,1]` with `r sp_la[1,2]` awards.

```{r lamap, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.align="center"}
## For map
library(rgdal)
library(viridis)
library(plyr)

setwd("input/Local_Authority_Districts_April_2019_Boundaries_UK_BUC")
map1 <- readOGR(dsn = ".", layer = "Local_Authority_Districts_April_2019_Boundaries_UK_BUC", verbose = FALSE)

sg_df$lad19nm <- sg_df$LOCAL_AUTHORITY
df <- sg_df


## map without distortion
map1@data$id <- rownames(map1@data)
map1@data   <- join(map1@data, df, by="lad19nm")
map1$AWARD[is.na(map1$AWARD)] <- 0
map.clean     <- fortify(map1)
map.clean     <- join(map.clean,map1@data, by="id")

map.clean <- map.clean[grep("E", map.clean$lad19cd),] # England only
map.clean <- map.clean[, !duplicated(colnames(map.clean))] # remove dupe cols


ggplot() +
  geom_polygon(data = map.clean, aes(x = long, y = lat, group = group, fill = AWARD))+
  theme_minimal() + 
  theme(axis.title.x = element_blank(),axis.title.y = element_blank(), 
        text = element_text(family = "Norwester", color = "#5F5F5F"), 
        plot.title=element_text(size=14,family = "Norwester", face="bold", hjust = 0.5),
        panel.grid = element_blank(), 
        axis.text = element_blank(),
        axis.ticks.x = element_blank())+
  scale_fill_gradient(high = '#4a1486' , low = '#f2f0f7' ,
                      name='Award Amount', labels = scales::dollar_format(prefix = "£"))


```

<br>

# Environmental Indicators

We can also look at a number of environmental indicators that impact on the communities that the funding is targeting. The Index of Multiple Deprivation is the aggregate of all the different indicators (Crime, Employment, etc.), and this Index gives a relative score of deprivation in a locale.
The project in the most deprived area (`r sp_la_imd$LOCAL_AUTHORITY[1]`) is titled "`r sp_la_imd$PROJECT_TITLE[1]`", and was awarded `r paste0("£", formatC(mean(sp_la_imd$AWARD[1]), format = "f", digits=2, big.mark=","))`
The below chart shows the distribution of projects by IMD decile.

```{r imd, echo=FALSE, message=FALSE, warning=FALSE, fig.align="center"}
ggplot(sg_df)+
  geom_histogram(aes(IMD_DECILE), fill = "#00818F", binwidth = 1 )+
  theme(text = element_text(family = "Norwester", size = 12, color = "#5F5F5F"),
        plot.title=element_text(size=14,family = "Norwester", face="bold", hjust = 0.5, color = "#525252"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        plot.caption=element_text(size=9, hjust=0, margin=margin(15,0,0,0)),
        legend.position = "left")  +
  scale_color_manual(values = se_colour, name = "Government\n Outcome")+
  labs( x= "Decile", y = "Number of awards", title = "IMD Decile Distribution",
        caption = ("1 is most deprived, 10 is least deprived"))+
  scale_x_continuous(labels = scales::comma)+
  scale_y_continuous(labels = scales::comma)
  

```

<br>

# Text Analysis 
Using the "12 month progress" field, we can look at the unstructured data of the Measure and Evaluation element of an award. We can do this using word frequency, topic extraction using LDA (Latent Dirichlet Modelling), and also assigning sentiment. 

<br>

## Term frequency score
The wordcloud was produced through text processing ) which stripped out punctuation and non-relevant words, and the word frequency was weighted with the 'importance' given to each word.

```{r 12_prog, echo=FALSE, fig.align="center", message=FALSE, warning=FALSE}

wordcloud2(text_df[,c(2,4)], fontFamily = "Norwester", color = "random-light")

```

<br>

## Topics

The topic modelling was created using the LDA model, and the "Elbow" method applied to assign the number of topics (more information at this [site](https://www.knime.com/blog/topic-extraction-optimizing-the-number-of-topics-with-the-elbow-method)).

```{r 12_prog_top, echo=FALSE, fig.align="center", message=FALSE, warning=FALSE}

kable(topic_tbl)
```

<br>

## Sentiment
Sentiment score using a lexicon-based approach: The approach assigns a sentiment to each word of positive or negative. This can be translated int a score (number of positive words - number of negative words) / total number of words).

The number of Small Grants projects with a comment in the "12 month progress" field: `r nrow(sentiment_df)`

<br>

### Proportion of projects with positive / negative sentiment

* Positive comments: `r sent_tab[1]`
* Negative comments: `r sent_tab[2]`

```{r Sent_pie, echo=FALSE, fig.align="center", message=FALSE, warning=FALSE}
ggplot(sentiment_df)+
  geom_bar(aes(x="", y = Sentiment, fill = Sentiment), stat = "identity" ) +
  coord_polar("y", start = 0)+
  theme(text = element_text(family = "Norwester", size = 12, color = "#525252"),
        plot.title=element_text(size=14,family = "Norwester", face="bold", hjust = 0.5, color = "#525252"),
        axis.text.x = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        plot.caption=element_text(size=9, hjust=0, margin=margin(15,0,0,0)),
        legend.position = "right") +
  labs( x= "", y = "", title = "Sentiment")+
    scale_fill_manual(values = se_colour)
```

<br>

### Example of sentiment scoring

```{r Sent, echo=FALSE, fig.align="center", message=FALSE, warning=FALSE}

kable(sentiment_df[1,])

```
